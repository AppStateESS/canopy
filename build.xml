<?xml version="1.0" encoding="UTF-8"?>

<project name="phpwebsite-core" default="build">
    <property environment="env" />

    <target name="build"
        depends="prepare,lint" />

    <target name="build-parallel" />

    <target name="clean" description="Cleanup build artifacts">
        <delete dir="${basedir}/build"/>
    </target>

    <target name="prepare" depends="clean"
         description="Prepare for build">
        <mkdir dir="${basedir}/build/rpm"/>
    </target>

    <target name="lint">
        <apply executable="php" failonerror="true">
            <arg value="-l" />

            <fileset dir="${basedir}">
                <include name="**/*.php" />
                <exclude name="lib/**" />
                <modified />
            </fileset>

<!--            <fileset dir="${basedir}/tests">
                <include name="**/*.php" />
                <modified />
            </fileset>-->
        </apply>
    </target>

    <tarfileset id="phpwebsite-tarball" dir="${basedir}" prefix="phpwebsite/">
        <exclude name="**/.svn/**" />
        <exclude name="build/**" />
        <exclude name="build.xml" />
        <exclude name="phpwebsite.spec" />
        <exclude name="cache.properties" />
        <exclude name="convert/**" />
        <exclude name="setup/**" />
    </tarfileset>

    <target name="tarball" depends="build" description="Tar it up">
        <tar destfile="${basedir}/build/phpwebsite-${RELVERSION}-${RELEASE}.tar.bz2" compression="bzip2">
            <tarfileset refid="phpwebsite-tarball" />
        </tar>
    </target>

    <target name="rpm" depends="tarball" description="Build an RPM">
        <exec executable="rpmbuild">
            <arg value="--define" />
            <arg value="_topdir ${basedir}/build/rpm" />
            <arg value="--define" />
            <arg value="_rpmdir %{_topdir}" />
            <arg value="--define" />
            <arg value="_srcrpmdir %{_topdir}" />
            <arg value="--define" />
            <arg value="_rpmfilename %%{NAME}-%%{VERSION}-%%{RELEASE}.%%{ARCH}.rpm" />
            <arg value="--define" />
            <arg value="_specdir %{_topdir}" />
            <arg value="--define" />
            <arg value="_sourcedir ${basedir}/build" />
            <arg value="--define" />
            <arg value="vendor ESS" />
            <arg value="--define" />
            <arg value="version ${RELVERSION}" />
            <arg value="--define" />
            <arg value="release ${RELEASE}" />
            <arg value="--define" />
            <arg value="_signature gpg" />
            <arg value="--define" />
            <arg value="_gpg_path /etc/ess/gnupg" />
            <arg value="--define" />
            <arg value="_gpg_name Electronic Student Services" />
            <arg value="--define" />
            <arg value="_gpgbin /usr/bin/gpg" />            
            <arg value="--define" />
            <arg value="_binaries_in_noarch_packages_terminate_build 0" />
            <arg value="-bb" />
            <arg value="--sign" />
            <arg path="${basedir}/phpwebsite.spec" />
        </exec>
    </target>
</project>
